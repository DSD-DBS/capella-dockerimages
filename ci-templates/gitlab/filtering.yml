# SPDX-FileCopyrightText: Copyright DB Netz AG and the capella-collab-manager contributors
# SPDX-License-Identifier: Apache-2.0
# yaml-language-server: $schema=https://gitlab.com/gitlab-org/gitlab/-/raw/master/app/assets/javascripts/editor/schema/ci.json

derive:
  script:
    - |
      if [[ -n $DERIVE_RESULTS ]]; then
        mapfile -d ";" -t derive_results < <(echo -n "$DERIVE_RESULTS");
      else
        derive_results=();
      fi

    # Reset branch. This is helpful when chaining jobs
    # and a previous job pushes changes that should be
    # considered for the model badge generation.
    - |
      if [[ -n $CI_COMMIT_BRANCH ]]; then
        git fetch;
        git reset --hard origin/$CI_COMMIT_BRANCH;
      fi
    - pip install "capellambse[cli] @ git+https://github.com/DSD-DBS/py-capellambse.git@filtering-cli"
    - |
      xvfb-run python \
        -m capellambse.extensions.filtering derive \
        -m "${ENTRYPOINT:?}" \
        -o derived-projects \
        -p '{result.name}' \
        "${derive_results[@]/#/--result=}" \
        --exe="/opt/capella/capella"
    - |
      if [[ "${PUSH_DERIVED_MODELS:-1}" == "1" ]]; then
        for result in derived-projects/*; do
          DERIVED_PROJECTS_DIR="$(pwd)";
          cd "$result";
          DERIVED_PROJECT_DIR="$(pwd)";
          DERVIED_BRANCH_NAME="derived/$result" | sed 's/[^a-zA-Z0-9.-_]/-/g';
          TMP_DIR=$(mktemp -d);
          git clone "https://${GIT_USERNAME:?}:${GIT_PASSWORD:?}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "$TMP_DIR";
          cd "$TMP_DIR";
          git switch "$DERVIED_BRANCH_NAME" || git switch --orphan "$DERVIED_BRANCH_NAME";

          cp -r "$DERIVED_PROJECT_DIR" "$TMP_DIR"
          git add .
          git commit -m "feat: Add/update derived model '$result'"
          cd "$DERIVED_PROJECTS_DIR"
        done
      fi
  artifacts:
    paths:
      - "derived-projects"

  image:
    name: $DOCKER_REGISTRY/capella/cli:${CAPELLA_DOCKER_IMAGES_TAG}
    entrypoint: [""]

  variables:
    # The path to the model's entrypoint, i.e. the main AIRD file,
    # relative to the repository root.
    # Mandatory.
    # ENTRYPOINT: ""

    # Alternatively, set this to the name of a Docker image whose entrypoint is
    # the Capella binary. CAPELLA_EXECUTABLE will be ignored.
    # CAPELLA_DOCKERIMAGE: ""

    # Limit the derivation to the listed results.
    # A semicolon separated list of result names and/or their UUIDs.
    # Default: Empty, which means derive all results in the model.
    DERIVE_RESULTS: ""

    # Display environment variable for Xvfb
    # Do not change it.
    DISPLAY: ":99"

    # Request a specific capellambse version to be installed.
    # Mandatory.
    # CAPELLAMBSE_REVISION: ""
