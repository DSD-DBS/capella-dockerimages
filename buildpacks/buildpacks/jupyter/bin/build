#!/usr/bin/env bash
# SPDX-FileCopyrightText: Copyright DB InfraGO AG and contributors
# SPDX-License-Identifier: Apache-2.0

set -eo pipefail

mkdir -p ${CNB_LAYERS_DIR}/app
cp -r /app/capella/versions/${CAPELLA_VERSION}/dropins/* ${CNB_LAYERS_DIR}/app/

# In case someone had dropins in their archive, copy it to the dropins layer
if [ -n "$(ls -A /layers/capella/app/dropins 2>/dev/null)" ]; then
    cp -r "/layers/capella/app/dropins/"* ${CNB_LAYERS_DIR}/app/
fi

# Replace dropins folder with symbolic link to dropins layer
rm -rf /layers/capella/app/dropins
ln -s ${CNB_LAYERS_DIR}/app /layers/capella/app/dropins

python3 /app/buildpacks/buildpacks/capella-dropins/install_dropins.py

cat > "${CNB_LAYERS_DIR}/app.toml" << EOL
[types]
launch = true
EOL
