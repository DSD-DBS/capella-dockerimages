#!/usr/bin/env bash
# SPDX-FileCopyrightText: Copyright DB InfraGO AG and contributors
# SPDX-License-Identifier: Apache-2.0

set -eo pipefail

mkdir -p ${CNB_LAYERS_DIR}/app

python3 -m venv ${CNB_LAYERS_DIR}/app/venv
${CNB_LAYERS_DIR}/app/venv/bin/pip install --no-cache-dir supervisor

cat > "${CNB_LAYERS_DIR}/app/supervisord.conf" << EOL
[supervisord]
nodaemon=true
childlogdir=/layers/supervisord
EOL

cat > "${CNB_LAYERS_DIR}/app.toml" << EOL
[types]
launch = true
EOL

cat > "${CNB_LAYERS_DIR}/launch.toml" << EOL
[[processes]]
type = "supervisord"
command = ["${CNB_LAYERS_DIR}/app/venv/bin/supervisord", "-c", "${CNB_LAYERS_DIR}/app/supervisord.conf"]
default = true
EOL
